import{g as u,d as j,e as G,f as p,k as _,l as v,v as N,h as x,i as k,u as V,j as z,r as d,w as X,x as O,a as M,t as Y}from"./firebace-Cb3kG9CG.js";import{J as K}from"./just-validate.es-C73wyOde.js";import{d as L,c as Z}from"./redirect-DmAC5oee.js";import{c as ee,g as Q,a as W,d as re}from"./requests-8AYIeyfP.js";const B=JSON.parse(localStorage.getItem("user")||"[]"),T=u("#title"),R=u("#goal"),P=u("#link"),U=u("#discription"),S=u("#img");async function te(){if(!T||!R||!P||!U||!S)return;const e=T.value,r=R.value,n=P.value,o=U.value,s=S?.files?.[0];if(!s)return;const a=await ne(s);try{const t=await j(G(p,"prods"),{title:e,discription:o,goal:Number(r),link:n,img:a,collected:0,status:!1,userId:B.id,date:new Date().toLocaleDateString("ru-RU")}),i=_(p,"users",B.id);await v(i,{myProds:N(t.id)}),T.value="",R.value="",P.value="",U.value="",S.value=""}catch(t){console.error(t)}}async function ne(e){if(!e)throw new Error("Нет файла");const r=x(k,`prods/${e.name}`);return await V(r,e),await z(r)}const ae=JSON.parse(localStorage.getItem("user")||"[]");async function oe(e,r,n){const o=u(".all-orders__content");if(!o)return;const s=[],a=await ee(ae.id),t=a?.myProds,i=a?.role;if((!t||t.length===0)&&i!=="admin"){o.innerHTML="Ви не створювали зборів.";return}const f=new Map(r.map(c=>[c.id,c])),g=new Map(e.map(c=>[c.id,c]));if(i==="volunteer")for(const c of t){const l=g.get(c);if(!l)continue;const m=f.get(l.userId);let w=0;if(!m)return;m.score.forEach(b=>{w+=Number(b)});const y=w/m.score.length;s.push({id:l.id,img:l.img,title:l.title,goal:l.goal,collected:l.collected,userInfo:{id:m.id||"",name:`${m.name||"—"}`,surname:m.surname||"",score:Math.round(y)},date:l.date})}if(i==="admin")for(const c of e){const l=f.get(c.userId);let m=0;if(!l)return;l.score.forEach(y=>{m+=Number(y)});const w=m/l.score.length;s.push({id:c.id,img:c.img,title:c.title,goal:c.goal,collected:c.collected,userInfo:{id:c.userId,name:`${l?.name||"—"}`,surname:l?.surname||"",score:Math.round(w)||0},date:c.date})}o.innerHTML="",s.sort((c,l)=>q(l.date).getTime()-q(c.date).getTime()).forEach(c=>{se(c,o,r,n)})}function q(e){const[r,n,o]=e.split(".").map(Number);return new Date(o,n-1,r)}function se(e,r,n,o){const s=d("div",["prod",`prod_${e.id}`]),a=d("a",["prod__card","card",`card_${e.id}`]);a.href=`prod.html?id=${e.id}`;const t=d("div","card__img");t.innerHTML=`
    <img src="${e.img}" alt="${e.title}"/>
  `;const i=d("div","card__info"),f=d("div","card__title");f.innerText=e.title;const g=d("div","card__goal");g.innerHTML=`Мета: <span>${e.goal}</span> грн.`;const h=d("div","card__collected");h.innerHTML=`Зібрано: <span>${e.collected}</span> грн.`;const c=d("div",["card__progress-bar","progress-bar"]),l=d("div","progress-bar__progress");l.style.width=e.collected*100/e.goal+"%",c.appendChild(l);const m=d("div","card__user"),w=d("div","card__user-fio");w.innerHTML=`Волонтер: <span>${e.userInfo.surname} ${e.userInfo.name?e.userInfo.name.charAt(0).toUpperCase()+".":""}</span>`;const y=d("div","card__user-score");y.innerHTML=`
    ${e.userInfo.score} 
    <svg>
        <use href="#star"></use>
    </svg>`;const b=d("a",["card__change-prod","card__btn","btn","btn_yellow"]);b.innerText="Редагувати",b.href=`prod.html?id=${e.id}`;const $=d("button",["card__remove-prod","card__btn","btn","btn_red"]);$.innerText="Видалити",$.addEventListener("click",async()=>{await ce(e,n,o),le(r)});const C=d("button",["card__close-prod","card__btn","btn","btn_green"]);C.innerText="Закрити",C.addEventListener("click",async()=>{await de(e.id),L("закрито")}),m.appendChild(w),m.appendChild(y),i.append(f),i.append(g),i.append(h),i.append(c),i.append(m),a.append(t),a.append(i),s.appendChild(a),s.appendChild(b),s.appendChild(C),s.appendChild($),r.appendChild(s)}async function de(e){try{const r=_(p,"prods",e);await v(r,{status:!0})}catch(r){console.error(r)}}async function ie(e){try{const r=_(p,"prods",e);await Y(r)}catch(r){console.error(r)}}async function ce(e,r,n){try{const s=decodeURIComponent(e.img).split("/o/")[1].split("?")[0],a=x(k,s);await X(a),await ie(e.id);for(let t=0;t<r.length;t++){const i=r[t].myProds||[],f=r[t].supportedProds||[],g=_(p,"users",e.userInfo.id);i.includes(e.id)&&await v(g,{myProds:O(e.id)}),f.includes(e.id)&&await v(g,{supportedProds:O(e.id)})}for(let t=0;t<n.length;t++){const i=_(p,"payments",n[t].id);n[t].prodId===e.id&&await v(i,{status:"remove"})}M(`.prod_${e.id}`)?.forEach(t=>{t.remove()})}catch(o){console.error(o)}}function le(e){if(M(".all-orders__content .prod").length===0){if(e.innerHTML="",e.innerHTML="Ви не створювали зборів.",M(".my-orders__content .prod").length===0){const r=u(".my-orders__content");if(!r)return;r.innerHTML="",r.innerHTML="Ви не брали участі у зборах."}if(M(".payments__content .pay").length===0){const r=u(".payments__content");if(!r)return;r.innerHTML="",r.innerHTML="Донати відстні."}}}function Ie(){const e=u("#create-order-form");if(!e)return;const r=new K(e,{errorLabelStyle:{color:"#ff7d4e"},focusInvalidField:!0,lockForm:!1,validateBeforeSubmitting:!0});r.addField("#title",[{rule:"required",errorMessage:"Введіть назву збору"},{rule:"minLength",value:2,errorMessage:"Довжина назви повинна бути більше 1 літери"},{rule:"maxLength",value:50,errorMessage:"Довжина назви повинна бути менше"}]).addField("#goal",[{rule:"required",errorMessage:"Це обов'язкове поле"}]).addField("#link",[{rule:"required",errorMessage:"Це поле обовʼязкове"},{rule:"customRegexp",value:/^https:\/\/send\.monobank\.ua\/\w+/,errorMessage:"Введіть коректне посилання на банку Monobank"}]).addField("#discription",[{rule:"required",errorMessage:"Це обов'язкове поле для заповнення"},{rule:"minLength",value:20,errorMessage:"Напишіть трохи більше інформації"}]).addField("#img",[{rule:"minFilesCount",value:1,errorMessage:"Будь ласка, додайте файл"}]),r.onSuccess(async()=>{await te();const n=await Q(),o=await W(),s=await re();!n||!o||!s||(await oe(n,o,s),L("збір"))})}const A=JSON.parse(localStorage.getItem("user")||"[]"),H=u("#title-new"),E=u("#new-text"),F=u("#new-img");async function ue(){if(!H||!E||!F)return;const e=H.value,r=E.value,n=F?.files?.[0];if(!n)return;const o=await me(n);try{const s=await j(G(p,"news"),{title:e,info:r,img:o,date:new Date().toLocaleDateString("ru-RU"),userId:A.id}),a=_(p,"users",A.id);await v(a,{myNews:N(s.id)}),H.value="",E.value="",F.value=""}catch(s){console.error(s)}}async function me(e){if(!e)throw new Error("Нет файла");const r=x(k,`news/${e.name}`);return await V(r,e),await z(r)}function be(){const e=u("#create-new-form");if(!e)return;const r=new K(e,{errorLabelStyle:{color:"#ff7d4e"},focusInvalidField:!0,lockForm:!1,validateBeforeSubmitting:!0});r.addField("#title-new",[{rule:"required",errorMessage:"Введіть назву новини"},{rule:"minLength",value:2,errorMessage:"Довжина назви повинна бути більше 1 літери"},{rule:"maxLength",value:50,errorMessage:"Довжина назви повинна бути менше"}]).addField("#new-text",[{rule:"required",errorMessage:"Це обов'язкове поле для заповнення"},{rule:"minLength",value:200,errorMessage:"Напишіть трохи більше інформації"}]).addField("#new-img",[{rule:"minFilesCount",value:1,errorMessage:"Будь ласка, додайте файл"}]),r.onSuccess(async()=>{await ue(),L("новина")})}const I=u(".payments__content"),pe=JSON.parse(localStorage.getItem("user")||"[]");async function Me(e,r,n){const o=[];e.forEach(a=>{r.forEach(t=>{n.forEach(i=>{a.prodId===t.id&&i.id===a.userId&&pe.id===t.userId&&a.status==="waiting"&&o.push({id:a.id,date:a.date,img:a.img,prod:{id:t.id,title:t.title,collected:t.collected},prodUserId:a.prodUserId,status:a.status,sum:a.sum,user:{id:i.id,name:i.name,surname:i.surname}})})})});const s=o.sort((a,t)=>J(t.date).getTime()-J(a.date).getTime());I&&(I.innerHTML="",s.forEach(a=>{fe(a)}),D())}function J(e){const[r,n,o]=e.split(".").map(Number);return new Date(o,n-1,r)}async function fe(e){if(!I)return;const r=d("div",["pay",`pay_${e.id}`,`prod_${e.prod.id}`]),n=d("div","pay__img");n.innerHTML=`
  <img src="${e.img}" alt="${e.date}"></img>
  `;const o=d("div","pay__info"),s=d("p","pay__name");s.innerHTML=`<span>Збір: </span>${e.prod.title}`;const a=d("p","pay__sum");a.innerHTML=`<span>Сума платежу: </span>${e.sum} грн.`;const t=d("p","pay__date");t.innerHTML=`<span>Дата здійснення платежу: </span>${e.date}`;const i=d("p","pay__user");i.innerHTML=`<span>Від кого було здійснено платіж: </span>${e.user.name} ${e.user.surname}`;const f=d("div","pay__btns"),g=d("button",["pay__btn","btn","btn_green","pay__agree"]);g.innerText="Підтвердити",g.addEventListener("click",async()=>{await ge(e,r),L("підтверджено")});const h=d("button",["pay__btn","btn","btn_red","pay__remove"]);h.innerText="Відхилити",h.addEventListener("click",async()=>{await _e(e,r),L("відхилено")}),f.appendChild(g),f.appendChild(h),o.appendChild(s),o.appendChild(a),o.appendChild(t),o.appendChild(i),o.appendChild(f),r.appendChild(n),r.appendChild(o),I.appendChild(r)}async function ge(e,r){try{const n=_(p,"payments",e.id);await v(n,{status:"done"});const o=_(p,"prods",e.prod.id);await v(o,{collected:Number(e.prod.collected+Number(e.sum))});const s=_(p,"users",e.user.id);await v(s,{supportedProds:N(e.prod.id)}),r.remove();const a=await Q(),t=await W();if(!a||!t)return;await Z(a,t),D()}catch(n){console.error(n)}}async function _e(e,r){try{const n=_(p,"payments",e.id);await v(n,{status:"remove"}),r.remove(),D()}catch(n){console.error(n)}}function D(){M(".pay").length===0&&I&&(I.innerText="Донати відстні.")}export{be as a,Me as p,oe as r,Ie as v};
